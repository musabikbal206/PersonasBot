<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Persona Bot - Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Dynamic Viewport Height */
        body { height: 100vh; height: 100dvh; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #52525b; }
        
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(15px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .message-animate { animation: slideUpFade 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }
        .animate-ping-slow { animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite; }

        input, textarea, select { font-size: 16px !important; }
        * { -webkit-tap-highlight-color: transparent; }

        .gold-text { background: linear-gradient(135deg, #fcd34d 0%, #f59e0b 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .action-btn { opacity: 0; transform: translateX(10px); transition: all 0.2s ease; }
        .persona-item:hover .action-btn { opacity: 1; transform: translateX(0); }
        @media (hover: none) { .action-btn { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="bg-zinc-950 font-sans antialiased text-zinc-100 flex overflow-hidden selection:bg-orange-500/30">

    <!-- AUTH MODAL -->
    <div id="auth-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md transition-opacity duration-200">
        <div class="bg-zinc-900 border border-zinc-800 rounded-2xl w-full max-w-sm shadow-2xl m-4 flex flex-col relative overflow-hidden">
            <div class="h-1 w-full bg-gradient-to-r from-orange-500 via-red-500 to-purple-600"></div>
            <div class="flex p-2 bg-zinc-950 border-b border-zinc-800 gap-2">
                <button onclick="switchAuthTab('login')" id="tab-login" class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all duration-200">Sign In</button>
                <button onclick="switchAuthTab('register')" id="tab-register" class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all duration-200">Create Account</button>
            </div>
            <div class="p-8">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-2">üîê</div>
                    <h2 id="auth-title" class="text-xl font-bold text-white">Welcome Back</h2>
                    <p class="text-zinc-500 text-xs mt-2">Login to access your database.</p>
                </div>
                <form id="auth-form" class="space-y-4">
                    <input type="email" id="auth-email" required placeholder="Email Address" class="w-full bg-black/50 border border-zinc-700 text-white px-4 py-3 rounded-xl focus:border-orange-500 outline-none">
                    <input type="password" id="auth-password" required placeholder="Password" class="w-full bg-black/50 border border-zinc-700 text-white px-4 py-3 rounded-xl focus:border-orange-500 outline-none">
                    <button type="submit" id="auth-submit-btn" class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white py-3.5 rounded-xl font-bold mt-2">Sign In</button>
                </form>
                <div id="auth-error" class="mt-4 text-red-400 text-xs text-center hidden"></div>
            </div>
        </div>
    </div>

    <!-- NOTIFICATIONS MODAL (Fixed Z-Index & Visibility) -->
    <div id="notif-modal" class="fixed inset-0 z-[90] flex items-start justify-end p-4 pointer-events-none hidden">
        <div class="bg-zinc-900 border border-zinc-800 rounded-2xl w-full max-w-xs shadow-2xl pointer-events-auto mt-14 mr-2 transform transition-all">
            <div class="p-4 border-b border-zinc-800 flex justify-between items-center">
                <h3 class="text-sm font-bold text-white">Notifications</h3>
                <button onclick="toggleNotifModal(false)" class="text-zinc-500 hover:text-white font-bold px-2">‚úï</button>
            </div>
            <div id="notif-list" class="max-h-[300px] overflow-y-auto custom-scrollbar p-2 space-y-2 bg-black/20">
                <div class="text-center py-4 text-zinc-500 text-xs">Loading...</div>
            </div>
        </div>
    </div>

    <!-- SETTINGS & ADMIN MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-sm hidden">
        <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 w-full max-w-md shadow-2xl m-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-white">‚öôÔ∏è Settings</h2>
                <button onclick="toggleModal('settings-modal', false)" class="text-zinc-500 hover:text-white">‚úï</button>
            </div>

            <div class="mb-6 bg-zinc-950/50 rounded-xl p-4 border border-zinc-800">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded-full bg-zinc-800 flex items-center justify-center text-lg">üë§</div>
                    <div class="flex-1 min-w-0">
                        <div id="user-email-display" class="font-medium text-sm truncate text-white">...</div>
                        <div id="user-status-display" class="text-xs text-zinc-500">Loading...</div>
                    </div>
                </div>
                <button id="logout-btn" class="w-full text-xs bg-red-900/20 text-red-300 py-2 rounded-lg border border-red-900/30">Sign Out</button>
            </div>

            <!-- ADMIN DASHBOARD -->
            <div id="admin-dashboard" class="hidden mb-6 space-y-4">
                <div class="bg-zinc-900 rounded-xl p-4 border border-orange-900/30 ring-1 ring-orange-500/20">
                    <h3 class="text-sm font-bold text-orange-500 uppercase mb-2">üõ°Ô∏è Admin Console</h3>
                    
                    <!-- Premium Requests -->
                    <div class="mb-4">
                        <p class="text-[10px] text-zinc-400 uppercase font-bold mb-2">Premium Requests</p>
                        <div id="admin-request-list" class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar bg-black/30 rounded-lg p-2 min-h-[40px]">
                            <div class="text-zinc-500 text-xs text-center py-2">Loading...</div>
                        </div>
                    </div>

                    <!-- API Key Requests -->
                    <div class="mb-2 pt-2 border-t border-zinc-800">
                        <p class="text-[10px] text-zinc-400 uppercase font-bold mb-2">API Key Requests (Manual Send)</p>
                        <div id="admin-api-list" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar bg-black/30 rounded-lg p-2 min-h-[40px]">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- USER SETTINGS -->
            <div id="premium-section" class="mb-6">
                <label class="block text-xs font-bold text-yellow-500 uppercase mb-2">üëë Unlock Premium</label>
                <button id="request-premium-btn" class="w-full bg-zinc-800 hover:bg-zinc-700 text-orange-500 border border-orange-500/20 py-2 rounded-xl font-medium text-xs transition-all">
                    Request Access from Admin
                </button>
            </div>

            <div class="pt-4 border-t border-zinc-800">
                <label class="block text-xs font-bold text-zinc-500 uppercase mb-2">üß† Gemini API Key</label>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="gemini-key-input" placeholder="Paste key here" class="flex-1 bg-black/50 border border-zinc-700 text-white px-3 py-2 rounded-xl text-sm">
                    <button id="save-gemini-btn" class="bg-zinc-800 px-4 py-2 rounded-xl text-xs font-bold hover:bg-zinc-700">Save</button>
                </div>
                <button id="request-apikey-btn" class="w-full bg-zinc-900 border border-zinc-700 text-blue-400 py-2 rounded-xl font-medium text-xs">Request Key from Admin</button>
            </div>
        </div>
    </div>

    <!-- CREATE/EDIT MODAL -->
    <div id="create-modal" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-sm hidden">
        <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 w-full max-w-md shadow-2xl m-4 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-white">Create Character</h2>
                <button onclick="toggleModal('create-modal', false)" class="text-zinc-500 hover:text-zinc-300">‚úï</button>
            </div>
            <div class="space-y-4 pr-2 flex-1">
                <input type="hidden" id="edit-persona-id">
                <input type="text" id="new-persona-name" placeholder="Name" class="w-full bg-black/30 border border-zinc-700 text-white px-4 py-3 rounded-xl">
                <textarea id="new-persona-prompt" rows="6" placeholder="Instructions (You are...)" class="w-full bg-black/30 border border-zinc-700 text-white px-4 py-3 rounded-xl resize-none"></textarea>
            </div>
            <button id="save-persona-btn" class="w-full mt-4 bg-white text-black hover:bg-zinc-200 py-3 rounded-xl font-bold text-sm">Save to Database</button>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden md:hidden transition-opacity duration-300"></div>
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-[85vw] max-w-[320px] md:w-80 bg-zinc-900 border-r border-zinc-800 flex flex-col transition-transform duration-300 -translate-x-full md:translate-x-0 md:relative">
        <div class="p-4 border-b border-zinc-800/50 flex justify-between items-center bg-zinc-900/50 backdrop-blur-md">
            <h2 class="text-base font-bold text-zinc-100">üé≠ Personas</h2>
            <button id="close-sidebar-btn" class="md:hidden p-2 text-zinc-400">‚úï</button>
        </div>
        <div class="px-4 py-3 border-b border-zinc-800/30">
            <input type="text" id="persona-search" placeholder="Filter characters..." class="w-full bg-zinc-950/50 border border-zinc-800 text-zinc-200 text-sm rounded-xl px-4 py-2.5">
        </div>
        <div id="persona-list" class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2"></div>
        <div class="p-4 border-t border-zinc-800 bg-zinc-900 space-y-2">
            <button id="open-create-btn" class="w-full flex items-center justify-center gap-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-200 font-medium py-3 px-4 rounded-xl text-sm">
                <span class="text-orange-500">+</span> Create Custom
            </button>
            <button id="surprise-me-btn" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-orange-900/40 to-red-900/40 hover:from-orange-900/60 hover:to-red-900/60 text-orange-200 font-medium py-3 px-4 rounded-xl text-sm border border-orange-500/20">
                üé≤ Surprise Me
            </button>
        </div>
    </aside>

    <!-- MAIN CHAT -->
    <div class="flex-1 flex flex-col relative w-full bg-zinc-950 h-full">
        <header class="bg-zinc-900/80 backdrop-blur-xl border-b border-zinc-800/50 h-14 md:h-16 flex items-center px-4 z-30 justify-between sticky top-0">
            <div class="flex items-center gap-3 overflow-hidden">
                <!-- HAMBURGER MENU BUTTON -->
                <button id="menu-btn" class="md:hidden p-2 -ml-2 text-zinc-400 hover:text-white rounded-full hover:bg-zinc-800">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                </button>
                <div id="header-emoji" class="text-2xl hidden sm:block w-8 h-8 flex items-center justify-center bg-zinc-800 rounded-lg">ü§ñ</div>
                <h1 id="persona-title" class="text-base md:text-lg font-bold text-zinc-100 truncate">Select a Character</h1>
            </div>
            <div class="flex items-center gap-2">
                <!-- NOTIFICATION BELL -->
                <button id="notif-btn" class="relative text-zinc-400 hover:text-white p-2 rounded-full hover:bg-zinc-800">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                    <span id="notif-badge" class="absolute top-1.5 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-zinc-900 hidden"></span>
                </button>
                <button onclick="toggleModal('settings-modal', true)" class="text-zinc-400 hover:text-white p-2 rounded-full hover:bg-zinc-800">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </header>

        <main id="chat-window" class="flex-1 overflow-y-auto custom-scrollbar p-4 pb-4 scroll-smooth w-full">
            <div id="chat-container" class="max-w-3xl mx-auto w-full space-y-6 min-h-full flex flex-col">
                <div id="empty-state" class="flex-1 flex flex-col items-center justify-center text-zinc-700 space-y-4 py-20">
                    <div class="text-4xl animate-pulse">üëà</div>
                    <p class="text-sm text-zinc-500">Select a character to begin.</p>
                </div>
            </div>
        </main>

        <div id="loading" class="hidden absolute bottom-20 left-1/2 transform -translate-x-1/2 bg-zinc-800/90 px-4 py-2 rounded-full shadow-xl flex items-center gap-3 z-20 border border-zinc-700">
            <div class="animate-spin h-4 w-4 border-2 border-orange-500 border-t-transparent rounded-full"></div>
            <span class="text-xs text-zinc-200">Thinking...</span>
        </div>

        <footer class="bg-zinc-900/80 backdrop-blur-xl border-t border-zinc-800/50 p-3 md:p-4 z-30">
            <div class="max-w-3xl mx-auto w-full">
                <form id="chat-form" class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Type a message..." class="flex-1 bg-zinc-800/50 text-zinc-100 border border-zinc-700/50 rounded-2xl px-4 py-3 focus:outline-none focus:border-orange-500/50 transition-all" disabled>
                    <button type="submit" id="send-btn" class="bg-orange-600 text-white font-bold rounded-2xl px-6 py-3 hover:bg-orange-500 disabled:opacity-50" disabled>Send</button>
                </form>
            </div>
        </footer>
    </div>

    <script>
        const SUPABASE_URL = "https://ebxseyidrikvdhgktiot.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVieHNleWlkcmlrdmRoZ2t0aW90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzY5MTEsImV4cCI6MjA3OTExMjkxMX0.lQjQWTedbSii87cPkoaU1A271yZbCJITQ2Q3eNnaYhM";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let state = {
            user: null,
            profile: null,
            personas: [],
            activePersonaId: null,
            currentPrompt: "",
            geminiKey: localStorage.getItem('gemini_key') || "",
            history: [],
            authMode: 'login'
        };

        const els = {
            authModal: document.getElementById('auth-modal'),
            chatContainer: document.getElementById('chat-container'),
            chatInput: document.getElementById('chat-input'),
            notifList: document.getElementById('notif-list'),
            notifBadge: document.getElementById('notif-badge'),
            personaList: document.getElementById('persona-list'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay')
        };

        /* --- INIT & AUTH --- */
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                await handleSession(session.user);
            } else {
                els.authModal.classList.remove('hidden');
            }
            if(state.geminiKey) document.getElementById('gemini-key-input').value = state.geminiKey;
        }

        async function handleSession(user) {
            state.user = user;
            els.authModal.classList.add('hidden');
            
            const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            state.profile = profile;
            
            document.getElementById('user-email-display').textContent = user.email;
            updateProfileUI();
            await loadPersonas();
            startNotificationPolling(); // Use polling for reliability
        }

        window.switchAuthTab = (mode) => {
            state.authMode = mode;
            const activeClass = "flex-1 py-2.5 text-sm font-bold rounded-lg transition-all duration-200 bg-zinc-800 text-white shadow";
            const inactiveClass = "flex-1 py-2.5 text-sm font-bold rounded-lg transition-all duration-200 text-zinc-500 hover:text-white";
            document.getElementById('tab-login').className = mode === 'login' ? activeClass : inactiveClass;
            document.getElementById('tab-register').className = mode === 'register' ? activeClass : inactiveClass;
            document.getElementById('auth-submit-btn').textContent = mode === 'login' ? "Sign In" : "Create Account";
        };

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const btn = document.getElementById('auth-submit-btn');
            const errDiv = document.getElementById('auth-error');
            
            btn.textContent = "Processing...";
            errDiv.classList.add('hidden');
            
            try {
                let error;
                if (state.authMode === 'register') {
                    const res = await supabase.auth.signUp({ email, password });
                    error = res.error;
                    if(!error) alert("Account created! Please log in.");
                } else {
                    const res = await supabase.auth.signInWithPassword({ email, password });
                    error = res.error;
                    if(res.data.user) await handleSession(res.data.user);
                }
                if(error) throw error;
            } catch(err) {
                errDiv.textContent = err.message;
                errDiv.classList.remove('hidden');
            }
            btn.textContent = state.authMode === 'login' ? "Sign In" : "Create Account";
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            location.reload();
        });

        /* --- SIDEBAR & UI LOGIC --- */
        window.toggleSidebar = () => {
            els.sidebar.classList.toggle('-translate-x-full');
            els.sidebarOverlay.classList.toggle('hidden');
        };
        document.getElementById('menu-btn').onclick = toggleSidebar;
        document.getElementById('close-sidebar-btn').onclick = toggleSidebar;
        els.sidebarOverlay.onclick = toggleSidebar;

        window.toggleModal = (id, show) => {
            document.getElementById(id).classList.toggle('hidden', !show);
        };

        document.getElementById('surprise-me-btn').onclick = () => {
            // Filter unlocked personas
            const unlocked = state.personas.filter(p => {
                if(p.isLocked && !state.profile.is_premium && !state.profile.is_admin) return false;
                return true;
            });
            if(unlocked.length > 0) {
                const random = unlocked[Math.floor(Math.random() * unlocked.length)];
                selectPersona(random);
            }
        };

        /* --- NOTIFICATIONS (POLLING) --- */
        document.getElementById('notif-btn').onclick = () => {
            const modal = document.getElementById('notif-modal');
            const isHidden = modal.classList.contains('hidden');
            modal.classList.toggle('hidden', !isHidden);
            if (isHidden) els.notifBadge.classList.add('hidden'); // Hide badge when opened
        };

        function startNotificationPolling() {
            fetchNotifications();
            setInterval(fetchNotifications, 5000); // Check every 5 seconds
        }

        async function fetchNotifications() {
            if (!state.user) return;
            const { data: notifs } = await supabase.from('notifications')
                .select('*')
                .eq('user_id', state.user.id)
                .eq('is_read', false)
                .order('created_at', { ascending: false });

            const list = els.notifList;
            
            if (notifs && notifs.length > 0) {
                list.innerHTML = '';
                els.notifBadge.classList.remove('hidden');
                notifs.forEach(n => {
                    const div = document.createElement('div');
                    div.className = "bg-zinc-800/90 p-3 rounded-xl text-xs text-zinc-300 border border-zinc-700/50 mb-2 shadow cursor-pointer hover:bg-zinc-800";
                    // Auto-detect key message
                    const isKey = n.message.includes("API Key");
                    div.innerHTML = `
                        <p class="font-bold ${isKey ? 'text-green-400' : 'text-orange-400'} mb-1 flex justify-between">
                            <span>${isKey ? 'üîë Key Received' : 'üîî System'}</span>
                            <span class="text-[10px] text-zinc-500">Click to dismiss</span>
                        </p>
                        <div class="break-all">${n.message}</div>
                    `;
                    div.onclick = () => markRead(n.id);
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = `<div class="text-center py-4 text-zinc-500 text-xs">No new notifications</div>`;
            }
        }

        async function markRead(id) {
            await supabase.from('notifications').update({ is_read: true }).eq('id', id);
            fetchNotifications();
        }

        /* --- ADMIN & SETTINGS --- */
        function updateProfileUI() {
            const p = state.profile;
            const statusEl = document.getElementById('user-status-display');
            
            if (p.is_admin) {
                statusEl.innerHTML = `<span class="text-orange-500 font-bold">Administrator</span>`;
                document.getElementById('admin-dashboard').classList.remove('hidden');
                document.getElementById('premium-section').classList.add('hidden');
                loadAdminData();
            } else if (p.is_premium) {
                statusEl.innerHTML = `<span class="gold-text font-bold">‚òÖ Premium Member</span>`;
                document.getElementById('premium-section').classList.add('hidden');
            } else {
                statusEl.textContent = "Free Plan";
                if (p.premium_requested) {
                    document.getElementById('request-premium-btn').textContent = "Pending Approval...";
                    document.getElementById('request-premium-btn').disabled = true;
                }
            }
        }

        document.getElementById('request-premium-btn').onclick = async () => {
            await supabase.from('profiles').update({ premium_requested: true }).eq('id', state.user.id);
            state.profile.premium_requested = true;
            updateProfileUI();
        };

        document.getElementById('request-apikey-btn').onclick = async () => {
             await supabase.from('profiles').update({ api_key_requested: true }).eq('id', state.user.id);
             alert("Request sent to Admin!");
        };

        // ADMIN LOGIC
        async function loadAdminData() {
            // 1. Premium Requests
            const { data: premReqs } = await supabase.from('profiles').select('id, email').eq('premium_requested', true);
            const premList = document.getElementById('admin-request-list');
            premList.innerHTML = '';
            if (premReqs && premReqs.length > 0) {
                premReqs.forEach(u => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-zinc-900 p-2 rounded border border-zinc-800 text-xs mb-1";
                    div.innerHTML = `<span class="truncate w-32 text-zinc-300">${u.email}</span><button onclick="grantPremium('${u.id}')" class="text-green-400 font-bold hover:text-green-300">Grant</button>`;
                    premList.appendChild(div);
                });
            } else {
                premList.innerHTML = `<div class="text-zinc-500 text-xs text-center py-2">No requests</div>`;
            }

            // 2. API Key Requests (Manual Send)
            const { data: keyReqs } = await supabase.from('profiles').select('id, email').eq('api_key_requested', true);
            const keyList = document.getElementById('admin-api-list');
            keyList.innerHTML = '';
            if (keyReqs && keyReqs.length > 0) {
                keyReqs.forEach(u => {
                    const div = document.createElement('div');
                    div.className = "bg-zinc-900 p-2 rounded border border-zinc-800 text-xs mb-1";
                    div.innerHTML = `
                        <div class="mb-1 text-zinc-300">${u.email}</div>
                        <div class="flex gap-1">
                            <input type="text" id="key-input-${u.id}" placeholder="Paste Key" class="flex-1 bg-black border border-zinc-700 text-white px-1 rounded">
                            <button onclick="sendKey('${u.id}')" class="bg-blue-900/50 text-blue-300 px-2 rounded hover:bg-blue-800">Send</button>
                        </div>
                    `;
                    keyList.appendChild(div);
                });
            } else {
                keyList.innerHTML = `<div class="text-zinc-500 text-xs text-center py-2">No requests</div>`;
            }
        }

        window.grantPremium = async (id) => {
            await supabase.from('profiles').update({ is_premium: true, premium_requested: false }).eq('id', id);
            await supabase.from('notifications').insert({ user_id: id, message: "üéâ Your Premium access has been granted!" });
            loadAdminData();
        };

        window.sendKey = async (id) => {
            const input = document.getElementById(`key-input-${id}`);
            const key = input.value.trim();
            if(!key) return alert("Enter a key first");
            
            // Send as notification
            await supabase.from('notifications').insert({ user_id: id, message: "üîë Admin sent you an API Key: " + key });
            // Clear request flag
            await supabase.from('profiles').update({ api_key_requested: false }).eq('id', id);
            loadAdminData();
            alert("Key sent via Notification!");
        };

        /* --- CHAT & PERSONAS --- */
        const defaultPersonas = [
            { id: 'def_1', name: 'GloomBloom', emoji: 'üå´Ô∏è', fullText: "You are 'GloomBloom', an AI that finds profound beauty in sadness." },
            { id: 'def_2', name: 'HypeBeast', emoji: 'üî•', fullText: "You are 'HypeBeast', speak only in exaggerated internet slang." },
            { id: 'def_3', name: 'Grammar Gorgon', emoji: 'ü§ì', fullText: "You are 'Grammar Gorgon', you correct every grammar mistake." },
            { id: 'def_4', name: 'Cipher', emoji: 'üîÆ', fullText: "You are 'Cipher', speak only in riddles.", isLocked: true },
            { id: 'def_5', name: 'NanaBot', emoji: 'üç™', fullText: "You are 'NanaBot', a sweet grandmother who loves baking.", isLocked: true }
        ];

        async function loadPersonas() {
            const { data: customDB } = await supabase.from('personas').select('*').order('created_at', { ascending: false });
            const customMapped = (customDB || []).map(p => ({
                id: p.id,
                name: p.name,
                fullText: `You are '${p.name}'. ${p.prompt}`,
                emoji: p.emoji,
                isCustom: true
            }));
            state.personas = [...customMapped, ...defaultPersonas];
            renderPersonas();
        }

        function renderPersonas() {
            const list = els.personaList;
            list.innerHTML = '';
            const filter = document.getElementById('persona-search').value.toLowerCase();

            state.personas.forEach(p => {
                if (!p.name.toLowerCase().includes(filter)) return;
                const isLocked = p.isLocked && !state.profile.is_premium && !state.profile.is_admin;
                const div = document.createElement('div');
                div.className = `relative p-3 rounded-xl border mb-2 transition-all cursor-pointer group persona-item ${state.activePersonaId === p.id ? 'bg-orange-500/10 border-orange-500/30' : 'bg-zinc-800/30 border-transparent hover:bg-zinc-800'} ${isLocked ? 'opacity-75' : ''}`;
                div.onclick = () => isLocked ? toggleModal('settings-modal', true) : selectPersona(p);

                let actions = '';
                if (p.isCustom) {
                    actions = `<div class="absolute right-2 top-2 z-10"><button onclick="event.stopPropagation(); deletePersona('${p.id}')" class="action-btn p-1.5 rounded-lg bg-red-900/50 hover:bg-red-600 text-red-200">üóëÔ∏è</button></div>`;
                }

                div.innerHTML = `${actions}<div class="flex items-center gap-3"><div class="text-2xl bg-zinc-900/50 w-10 h-10 flex items-center justify-center rounded-lg">${p.emoji}</div><div><div class="font-bold text-sm text-zinc-200">${p.name} ${isLocked ? 'üîí' : ''}</div><div class="text-xs text-zinc-500 truncate w-40">${p.fullText}</div></div></div>`;
                list.appendChild(div);
            });
        }

        // CHAT
        function selectPersona(p) {
            state.activePersonaId = p.id;
            state.currentPrompt = p.fullText;
            document.getElementById('persona-title').textContent = p.name;
            document.getElementById('header-emoji').textContent = p.emoji;
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('chat-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            renderPersonas();
            if (window.innerWidth < 768) toggleSidebar();
            state.history = [];
            sendMessage("Hello! Introduce yourself.", true);
        }

        async function sendMessage(text, isHidden = false) {
            if (!isHidden) addMessage(text, 'user');
            state.history.push({ role: 'user', parts: [{ text }] });
            document.getElementById('loading').classList.remove('hidden');
            try {
                if (!state.geminiKey) throw new Error("Please save your Gemini API Key in Settings.");
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.geminiKey}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: state.history, systemInstruction: { parts: [{ text: state.currentPrompt }] } })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                const reply = data.candidates[0].content.parts[0].text;
                state.history.push({ role: 'model', parts: [{ text: reply }] });
                addMessage(reply, 'model');
            } catch (e) { addMessage(e.message, 'system'); } finally { document.getElementById('loading').classList.add('hidden'); }
        }

        function addMessage(text, type) {
            const d = document.createElement('div');
            d.className = 'w-full message-animate mb-4 px-2';
            if (type === 'user') d.innerHTML = `<div class="flex justify-end"><div class="bg-zinc-800 text-zinc-100 px-4 py-3 rounded-2xl rounded-tr-sm max-w-[90%] text-sm shadow border border-zinc-700/50">${text}</div></div>`;
            else if (type === 'model') d.innerHTML = `<div class="flex justify-start"><div class="bg-orange-600 text-white px-4 py-3 rounded-2xl rounded-tl-sm max-w-[90%] text-sm shadow">${text.replace(/\n/g, '<br>')}</div></div>`;
            else d.innerHTML = `<div class="text-center text-xs text-red-500 italic border border-red-900/50 bg-red-900/20 p-2 rounded-lg">${text}</div>`;
            els.chatContainer.appendChild(d);
            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
        }

        document.getElementById('save-persona-btn').onclick = async () => {
            const name = document.getElementById('new-persona-name').value;
            const prompt = document.getElementById('new-persona-prompt').value;
            const emoji = (prompt.match(/\p{Extended_Pictographic}/u) || ['ü§ñ'])[0];
            if(!state.profile.is_premium && !state.profile.is_admin) return alert("Premium only!");
            const { error } = await supabase.from('personas').insert({ user_id: state.user.id, name, prompt, emoji });
            if(!error) { toggleModal('create-modal', false); loadPersonas(); } else alert(error.message);
        };
        window.deletePersona = async (id) => { if(confirm("Delete?")) { await supabase.from('personas').delete().eq('id', id); loadPersonas(); } };
        document.getElementById('save-gemini-btn').onclick = () => { state.geminiKey = document.getElementById('gemini-key-input').value; localStorage.setItem('gemini_key', state.geminiKey); alert("Saved"); };
        document.getElementById('chat-form').onsubmit = (e) => { e.preventDefault(); const i = els.chatInput; if(i.value.trim()) { sendMessage(i.value); i.value=''; }};
        document.getElementById('open-create-btn').onclick = () => toggleModal('create-modal', true);

        init();
    </script>
</body>
</html>
